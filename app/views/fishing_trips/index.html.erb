<% if current_user %>
  <div class="current-user-info">
    уЈЙтюесЃГсѓ░сѓцсЃ│сЂЌсЂдсЂёсѓІсЃдсЃ╝сѓХсЃ╝: <%= current_user.username %>
  </div>
<% end %>
<% if session[:login_uid] %>
    <%= link_to "сЃГсѓ░сѓбсѓдсЃѕ", top_logout_path %>
<% end %>

<h2>С╗ќС║║сЂ«жЄБсѓітІЪжЏєСИђУдД</h2>
<%= form_with url: fishing_trips_path, method: :get, local: true, id: 'location-filter-form' do |form| %>
  <%= form.label :location, 'жЃйжЂЊт║юуюїсЂДухъсѓіУЙ╝сѓђ:' %>
  <%= form.select :location, [
    ['сЂЎсЂ╣сЂд', ''],
    'тїЌТхижЂЊ', 'жЮњТБ«уюї', 'т▓ЕТЅІуюї', 'т««тЪјуюї', 'уДІућ░уюї', 
    'т▒▒тйбуюї', 'удЈт│Хуюї', 'УїетЪјуюї', 'ТаЃТюеуюї', 'уЙцждгуюї', 
    'тЪ╝ујЅуюї', 'тЇЃУЉЅуюї', 'ТЮ▒С║гжЃй', 'уЦътЦѕтиЮуюї', 'Тќ░ТйЪуюї', 
    'т»їт▒▒уюї', 'уЪ│тиЮуюї', 'удЈС║Ћуюї', 'т▒▒Тбеуюї', 'жЋижЄјуюї', 
    'т▓љжўюуюї', 'жЮЎт▓Ауюї', 'ТёЏуЪЦуюї', 'СИЅжЄЇуюї', 'Т╗ІУ│ђуюї', 
    'С║гжЃйт║ю', 'тцДжўфт║ю', 'тЁхт║Фуюї', 'тЦѕУЅ»уюї', 'тњїТГїт▒▒уюї', 
    'ж│ЦтЈќуюї', 'т│ХТа╣уюї', 'т▓Ат▒▒уюї', 'т║Ѓт│Хуюї', 'т▒▒тЈБуюї', 
    'тЙ│т│Хуюї', 'ждЎтиЮуюї', 'ТёЏтфЏуюї', 'жФўуЪЦуюї', 'удЈт▓Ауюї', 
    'СйљУ│ђуюї', 'жЋит┤јуюї', 'уєіТюгуюї', 'тцДтѕєуюї', 'т««т┤јуюї', 
    'ж╣┐тЁљт│Хуюї', 'Т▓ќуИёуюї'
  ], selected: params[:location], include_blank: true %>
<% end %>




<% other_fishing_trips = @fishing_trips.select { |trip| current_user != trip.organizer && @user_participation_status[trip.id] != 'approved' && @user_participation_status[trip.id] != 'declined' } %>

<% if other_fishing_trips.any? %>
  <!-- сЃєсЃ╝сЃќсЃФсЂ«УАеуц║ -->
  <table class="table table-striped">
  <thead>
    <tr>
      <th>сѓ┐сѓцсЃѕсЃФ</th>
      <th>УЕ│у┤░</th>
      <th>жќІтѓгта┤ТЅђ</th>
      <th>жќІтѓгТЌЦ</th>
      <th>тІЪжЏєУђЁ</th>
      <th>уЈЙтюесЂ«тЈѓтіаС║║ТЋ░</th>
      <th>ућ│УФІ</th>
    </tr>
  </thead>

  <tbody>
    <% @fishing_trips.each do |fishing_trip| %>
      <% if current_user != fishing_trip.organizer && @user_participation_status[fishing_trip.id] != 'approved' && @user_participation_status[fishing_trip.id] != 'declined' %>
        <tr>
          <td><%= fishing_trip.title %></td>
          <td><%= fishing_trip.description %></td>
          <td><%= fishing_trip.location %></td>
          <td><%= fishing_trip.start_date %></td>
          <td><%= fishing_trip.organizer.username %></td>
          <td class="тЈѓтіаС║║ТЋ░">
            <% approved_participants_count = fishing_trip.participations.where(status: 'approved').count %>
            <%= "#{approved_participants_count}/#{fishing_trip.participant_limit}" %>
          </td>
          <td class="тЈѓтіауіХТ│Ђ">
            <% if @user_participation_status[fishing_trip.id] == 'pending' %>
              ТЅ┐УфЇтЙЁсЂА
            <% elsif approved_participants_count >= fishing_trip.participant_limit %>
              Т║ђтЊА­ЪЎЄ
            <% else %>
              <%= form_with url: participations_path, method: :post, class: "d-inline" do |form| %>
                <%= form.hidden_field :fishing_trip_id, value: fishing_trip.id %>
                <%= form.submit 'тЈѓтіасЂЎсѓІ', class: 'btn btn-primary' %>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>
<% else %>
  <p>тІЪжЏєсЂ»сЂѓсѓісЂЙсЂЏсѓЊсђѓ</p>
<% end %>


<h2>тЈѓтіаС║ѕт«џ</h2>
<% approved_fishing_trips = @fishing_trips.select { |trip| @user_participation_status[trip.id] == 'approved' } %>

<% if approved_fishing_trips.any? %>
  <!-- сЃєсЃ╝сЃќсЃФсЂ«УАеуц║ -->
    <table class="table table-striped">
    <thead>
      <tr>
        <th>сѓ┐сѓцсЃѕсЃФ</th>
        <th>УЕ│у┤░</th>
        <th>жќІтѓгта┤ТЅђ</th>
        <th>жќІтѓгТЌЦ</th>
        <th>тІЪжЏєУђЁ</th>
        <th>уЈЙтюесЂ«тЈѓтіаС║║ТЋ░</th>
        <th>сѓГсЃБсЃ│сѓ╗сЃФ</th>
      </tr>
    </thead>
    <tbody>
      <% approved_fishing_trips.each do |fishing_trip| %>
        <tr>
          <td><%= fishing_trip.title %></td>
          <td><%= fishing_trip.description %></td>
          <td><%= fishing_trip.location %></td>
          <td><%= fishing_trip.start_date %></td>
          <td><%= fishing_trip.organizer.username %></td>
          <td>
            <% approved_participants_count = fishing_trip.participations.where(status: 'approved').count %>
            <%= "#{approved_participants_count}/#{fishing_trip.participant_limit}" %>
          </td>
          <td>
            <!-- сѓГсЃБсЃ│сѓ╗сЃФ -->
            <% participation = @current_user_participations[fishing_trip.id].find { |p| p.user_id == current_user.id && p.status == 'approved' } %>
            <% if participation %>
              <%= form_with url: participation_path(participation), method: :patch do |form| %>
                <%= form.hidden_field :status, value: 'cancelled' %>
                <%= form.submit 'сѓГсЃБсЃ│сѓ╗сЃФ', class: 'btn btn-success' %>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>тЈѓтіаС║ѕт«џсЂ«тІЪжЏєсЂ»сЂѓсѓісЂЙсЂЏсѓЊсђѓ</p>
<% end %>


<h2>УЄфтѕєсЂ«тЄ║сЂЌсЂЪжЄБсѓітІЪжЏєСИђУдД</h2>
<% my_fishing_trips = @fishing_trips.select { |trip| @is_organizer[trip.id] } %>

<% if my_fishing_trips.any? %>
  <!-- сЃєсЃ╝сЃќсЃФсЂ«УАеуц║ -->
  <table class="table table-striped">
  <thead>
    <tr>
      <th>сѓ┐сѓцсЃѕсЃФ</th>
      <th>УЕ│у┤░</th>
      <th>жќІтѓгта┤ТЅђ</th>
      <th>жќІтѓгТЌЦ</th>
      <th>т┐ютІЪУђЁ</th>
      <th>тЈѓтіаУђЁ</th>
      <th>уЈЙтюесЂ«тЈѓтіаУђЁТЋ░</th>
    </tr>
  </thead>
  <% @fishing_trips.each do |fishing_trip| %>
    <% if @is_organizer[fishing_trip.id] %>
      <tbody>
        <tr>
          <td><%= fishing_trip.title %></td>
          <td><%= fishing_trip.description %></td>
          <td><%= fishing_trip.location %></td>
          <td><%= fishing_trip.start_date %></td>

          <td class="т┐ютІЪУђЁ">
            <% @each_all_participations[fishing_trip.id].each do |participation| %>
              <% if participation.pending? %>
                <div>
                  <% if participation.status == 'pending' || participation.status == 'approved' %>
                    <%= link_to participation.user.username, user_profiles_path(participation.user) %>
                    <% if participation.pending? %>
                      <%= form_with url: participation_path(participation), method: :patch do |form| %>
                        <%= form.hidden_field :status, value: 'approved' %>
                        <%= form.submit 'ТЅ┐УфЇ', class: 'btn btn-success' %>
                      <% end %>
                      <%= form_with url: participation_path(participation), method: :patch do |form| %>
                        <%= form.hidden_field :status, value: 'declined' %>
                        <%= form.submit 'тЇ┤СИІ', class: 'btn btn-danger' %>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </td>
          <td class="тЈѓтіаУђЁ">
            <% @each_all_participations[fishing_trip.id].each do |participation| %>
              <% if participation.approved? %>
                <%= link_to participation.user.username, user_profiles_path(participation.user) %>
              <% end %>
            <% end %>
          </td>
          <td class="тЈѓтіаС║║ТЋ░">
            <% approved_participants_count = fishing_trip.participations.where(status: 'approved').count %>
            <%= "#{approved_participants_count}/#{fishing_trip.participant_limit}" %>
          </td>
        </tr>
      </tbody>
    <% end %>
  <% end %>
</table>
<% else %>
  <p>тЄ║сЂЌсЂЪтІЪжЏєсЂ»сЂѓсѓісЂЙсЂЏсѓЊсђѓ</p>
<% end %>


<%= link_to 'Тќ░УдЈтІЪжЏєсѓњтЄ║сЂЎ', new_fishing_trip_path, class: 'btn btn-primary' %>

